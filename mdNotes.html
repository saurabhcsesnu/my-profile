<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Notes & Mind Maps</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- D3.js & Markmap -->
    <script src="https://cdn.jsdelivr.net/npm/d3"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view"></script>
    <!-- Cropper.js for Image Editing -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f5f9; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-weight: 600; margin-top: 1.25em; margin-bottom: 0.5em; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; }
        .markdown-body h1 { font-size: 2em; } .markdown-body h2 { font-size: 1.5em; }
        .markdown-body p { margin-bottom: 1em; line-height: 1.6; } .markdown-body ul, .markdown-body ol { margin-left: 1.5em; margin-bottom: 1em; }
        .markdown-body pre { background-color: #1e293b; color: #e2e8f0; padding: 1em; border-radius: 0.5rem; }
        .markdown-body a.internal-link { text-decoration: underline; color: #5b21b6; }
        #markmap-svg { width: 100%; height: 100%; }
        .mode-btn.active { background-color: white; color: #334155; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .loader { width: 16px; height: 16px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Cropper.js Fixes */
        #cropper-image-container {
            height: 60vh; /* Fixed height for the container */
            width: 100%;
            background-color: #f1f5f9;
        }
        #cropper-image {
            display: block; /* Important for Cropper.js */
            max-width: 100%; /* Ensure image is not larger than its container */
            max-height: 100%;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <!-- Main App -->
    <div id="app-container" class="flex h-screen">
        <aside class="w-1/4 max-w-xs bg-white border-r border-slate-200 flex flex-col">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center"><h1 class="text-xl font-bold text-slate-700">Notes</h1><button id="new-file-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg transition-colors">+ New</button></div>
            <div id="file-list" class="overflow-y-auto flex-grow p-2"><div id="file-list-loader" class="text-center p-4 text-slate-500">Loading files...</div></div>
            <div class="p-2 border-t border-slate-200 text-center"><p class="text-xs text-slate-400">User ID:</p><p id="user-id-display" class="text-xs text-slate-500 font-mono break-all"></p></div>
        </aside>
        <main id="main-content" class="flex-grow flex flex-col bg-slate-50">
            <div id="placeholder-screen" class="flex-grow flex items-center justify-center"><div class="text-center text-slate-500"><h2 class="text-2xl font-semibold mb-2">Welcome!</h2><p>Select or create a note to get started.</p></div></div>
            <div id="editor-screen" class="hidden flex-grow flex flex-col">
                <div class="p-3 bg-white border-b border-slate-200 flex justify-between items-center flex-wrap gap-3">
                    <div id="view-switcher" class="flex items-center gap-1 rounded-lg bg-slate-200 p-1"><button data-mode="view" class="mode-btn px-3 py-1 text-sm font-semibold rounded-md active">View</button><button data-mode="edit" class="mode-btn px-3 py-1 text-sm font-semibold rounded-md">Edit</button><button data-mode="mindmap" class="mode-btn px-3 py-1 text-sm font-semibold rounded-md">Mind Map</button></div>
                    <div id="ai-tools" class="flex items-center gap-2"><button id="summarize-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-3 rounded-lg transition-colors flex items-center gap-2"><span class="btn-text">✨ Summarize</span><span class="loader hidden"></span></button><button id="brainstorm-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-3 rounded-lg transition-colors flex items-center gap-2"><span class="btn-text">✨ Brainstorm</span><span class="loader hidden"></span></button></div>
                    <div class="flex items-center gap-2"><button id="publish-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg transition-colors">Publish</button><button id="save-btn" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button><button id="delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Delete</button></div>
                </div>
                <div class="flex-grow relative">
                    <div id="viewer" class="p-4 md:p-8 overflow-y-auto h-full markdown-body absolute inset-0"></div>
                    <textarea id="editor" class="hidden w-full h-full p-4 md:p-8 bg-white border-0 resize-none focus:outline-none font-mono text-base absolute inset-0"></textarea>
                    <div id="mindmap-viewer" class="hidden p-2 bg-white w-full h-full absolute inset-0"><svg id="markmap-svg"></svg></div>
                </div>
            </div>
        </main>
    </div>
    <!-- Modals -->
    <div id="notification-box" class="hidden fixed bottom-5 right-5 bg-slate-800 text-white py-2 px-4 rounded-lg shadow-lg z-40"></div>
    <div id="share-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-50"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-auto"><h3 class="text-lg font-medium text-slate-900 mb-2">Note Published!</h3><p class="text-sm text-slate-600 mb-4">Anyone with this link can view your note.</p><input id="share-url-input" type="text" readonly class="w-full bg-slate-100 text-slate-600 text-sm font-mono p-2 rounded border border-slate-300"><div class="flex justify-end gap-3 mt-4"><button id="copy-share-url-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Copy Link</button><button id="close-share-modal-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Close</button></div></div></div>
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full flex items-center justify-center z-50"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto"><h3 id="modal-title" class="text-lg font-medium text-slate-900 mb-4"></h3><p id="modal-body" class="text-sm text-slate-600 mb-6"></p><div class="flex justify-end gap-3"><button id="modal-cancel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancel</button><button id="modal-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Confirm</button></div></div></div>
    <div id="image-editor-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 h-full w-full flex items-center justify-center z-50 p-4"><div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl mx-auto flex flex-col"><h3 class="text-xl font-semibold text-slate-900 mb-4">Edit Image</h3><div id="cropper-image-container" class="mb-4"><img id="cropper-image"></div><div class="flex justify-end gap-3"><button id="cancel-crop-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancel</button><button id="confirm-crop-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><span class="btn-text">Upload Image</span><span class="loader hidden"></span></button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCVLXFS2or49REpWM8E_s5VBN4MF86uGSY",
            authDomain: "mdviewer-a52ea.firebaseapp.com",
            projectId: "mdviewer-a52ea",
            storageBucket: "mdviewer-a52ea.appspot.com",
            messagingSenderId: "49380689291",
            appId: "1:49380689291:web:508d22f05f7f4c964e1b8e",
            measurementId: "G-PEW342Z6B9"
        };
        const appId = 'my-markdown-notes-app';
        // --- PASTE YOUR GEMINI API KEY HERE ---
        const GEMINI_API_KEY = "AIzaSyDyNqJCYas2Pt-JEMYPyPAVzX6OKwZMZ4w";

        // --- App State ---
        let db, auth, storage, userId, currentFile = null, currentMode = 'view';
        let fileUnsubscribe = null, currentFileUnsubscribe = null, confirmCallback = null;
        let markmapInstance, transformer, cropper, loaderTimeout;
        const ui = {};

        // --- UI & Helper Functions ---
        function populateUI() {
            const ids = ["app-container", "file-list", "file-list-loader", "new-file-btn", "editor-screen", "placeholder-screen", "viewer", "editor", "mindmap-viewer", "markmap-svg", "save-btn", "delete-btn", "publish-btn", "summarize-btn", "brainstorm-btn", "user-id-display", "notification-box", "share-modal", "share-url-input", "copy-share-url-btn", "close-share-modal-btn", "confirmation-modal", "modal-title", "modal-body", "modal-cancel-btn", "modal-confirm-btn", "view-switcher", "image-editor-modal", "cropper-image", "cancel-crop-btn", "confirm-crop-btn"];
            ids.forEach(id => {
                const key = id.replace(/-(\w)/g, (_, letter) => letter.toUpperCase());
                ui[key] = document.getElementById(id);
            });
        }

        const showNotification = (message, isError = false) => {
            ui.notificationBox.textContent = message;
            ui.notificationBox.className = `fixed bottom-5 right-5 py-2 px-4 rounded-lg shadow-lg z-40 ${isError ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'}`;
            ui.notificationBox.classList.remove('hidden');
            setTimeout(() => ui.notificationBox.classList.add('hidden'), 3000);
        };

        const showConfirmation = (title, body, onConfirm) => {
            ui.modalTitle.textContent = title;
            ui.modalBody.textContent = body;
            confirmCallback = onConfirm;
            ui.confirmationModal.classList.remove('hidden');
        };

        const hideConfirmation = () => {
            confirmCallback = null;
            ui.confirmationModal.classList.add('hidden');
        };

        const setButtonLoadingState = (button, isLoading) => {
            const btnText = button.querySelector('.btn-text');
            const loader = button.querySelector('.loader');
            button.disabled = isLoading;
            if (btnText && loader) {
                btnText.classList.toggle('hidden', isLoading);
                loader.classList.toggle('hidden', !isLoading);
            }
        };

        const renderer = new marked.Renderer();
        renderer.link = (href, title, text) => {
             if (typeof href === 'string' && href.startsWith('file://')) {
                const fileId = href.substring(7);
                return `<a href="#" class="internal-link" data-file-id="${fileId}" title="Link to note: ${fileId}">${text}</a>`;
            }
            return new marked.Renderer().link.call(renderer, href, title, text);
        };
        marked.setOptions({ renderer });

        // --- Gemini API Logic ---
        const callGemini = async (prompt) => {
            if (!GEMINI_API_KEY) {
                showNotification("Gemini API Key is missing.", true);
                return null;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || "An unknown error occurred.");
                }

                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                showNotification(`AI Error: ${error.message}`, true);
                return null;
            }
        };

        // --- Core Application Logic ---
        const switchMode = (newMode) => {
            currentMode = newMode;
            ui.viewSwitcher.querySelectorAll('.mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === newMode));
            ui.viewer.classList.toggle('hidden', newMode !== 'view');
            ui.editor.classList.toggle('hidden', newMode !== 'edit');
            ui.mindmapViewer.classList.toggle('hidden', newMode !== 'mindmap');
            ui.saveBtn.classList.toggle('hidden', newMode !== 'edit');
            if (newMode === 'mindmap') {
                if (!transformer) transformer = new window.markmap.Transformer();
                if (markmapInstance) markmapInstance.destroy();
                const { root } = transformer.transform(ui.editor.value);
                markmapInstance = window.markmap.Markmap.create(ui.markmapSvg, null, root);
            }
            if (newMode === 'edit') ui.editor.focus();
        };

        const getPrivatePath = (fileId = '') => `artifacts/${appId}/users/${userId}/markdownFiles${fileId ? `/${fileId}` : ''}`;
        const getPublicPath = (fileId = '') => `artifacts/${appId}/publishedNotes${fileId ? `/${fileId}` : ''}`;

        const resetToPlaceholder = () => {
            currentFile = null;
            if(currentFileUnsubscribe) currentFileUnsubscribe();
            ui.editorScreen.classList.add('hidden');
            ui.placeholderScreen.classList.remove('hidden');
        };

        const updatePublishButton = (isPublished) => {
            if (isPublished) {
                ui.publishBtn.textContent = 'Unpublish';
                ui.publishBtn.classList.replace('bg-indigo-500', 'bg-slate-500');
                ui.publishBtn.classList.replace('hover:bg-indigo-600', 'hover:bg-slate-600');
            } else {
                ui.publishBtn.textContent = 'Publish';
                ui.publishBtn.classList.replace('bg-slate-500', 'bg-indigo-500');
                ui.publishBtn.classList.replace('hover:bg-slate-600', 'hover:bg-indigo-600');
            }
        };

        const selectFile = async (fileId) => {
            if (currentFile?.id === fileId) return;
            if (currentFileUnsubscribe) currentFileUnsubscribe();

            const fileRef = doc(db, getPrivatePath(fileId));
            currentFileUnsubscribe = onSnapshot(fileRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showNotification("Note was deleted or does not exist.", true);
                    resetToPlaceholder();
                    return;
                }
                currentFile = { id: docSnap.id, ...docSnap.data() };
                ui.editor.value = currentFile.content;
                ui.viewer.innerHTML = marked.parse(currentFile.content);
                updatePublishButton(!!currentFile.isPublished);

                ui.placeholderScreen.classList.add('hidden');
                ui.editorScreen.classList.remove('hidden');
                switchMode('view');

                document.querySelectorAll('#file-list > div').forEach(div => {
                    div.classList.toggle('bg-blue-100', div.dataset.id === fileId);
                    div.classList.toggle('text-blue-800', div.dataset.id === fileId);
                });

            }, (error) => {
                console.error("Error listening to file:", error);
                showNotification("Error loading note.", true);
            });
        };

        const saveCurrentFile = async () => {
            if (!currentFile || !userId) return false;
            try {
                const fileRef = doc(db, getPrivatePath(currentFile.id));
                await updateDoc(fileRef, { content: ui.editor.value });
                if(currentFile.isPublished) {
                    const publicRef = doc(db, getPublicPath(currentFile.id));
                    await updateDoc(publicRef, { content: ui.editor.value });
                }
                return true;
            } catch (error) {
                console.error("Save error:", error);
                showNotification("Could not save note.", true);
                return false;
            }
        };

        const setupFileListener = () => {
            if (fileUnsubscribe) fileUnsubscribe();
            if (!userId) { return; }

            const q = query(collection(db, getPrivatePath()));
            fileUnsubscribe = onSnapshot(q, (snapshot) => {
                clearTimeout(loaderTimeout);
                ui.fileListLoader.classList.add('hidden');

                if (snapshot.empty) {
                    ui.fileList.innerHTML = `<div class="p-4 text-sm text-slate-500">No notes yet. Create one!</div>`;
                } else {
                    const files = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    ui.fileList.innerHTML = '';
                    files.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                    files.forEach(fileData => {
                        const title = (fileData.content || '').split('\n')[0].replace(/#/g, '').trim() || 'Untitled Note';
                        const fileItem = document.createElement('div');
                        fileItem.className = `p-3 my-1 rounded-lg cursor-pointer flex justify-between items-center ${(currentFile && fileData.id === currentFile.id) ? 'bg-blue-100 text-blue-800' : 'hover:bg-slate-100'}`;
                        fileItem.innerHTML = `<span>${title}</span> ${fileData.isPublished ? '<span class="text-xs bg-indigo-100 text-indigo-700 font-semibold px-2 py-1 rounded-full">Public</span>' : ''}`;
                        fileItem.dataset.id = fileData.id;
                        ui.fileList.appendChild(fileItem);
                    });
                }
            }, (error) => {
                ui.fileListLoader.innerHTML = `<div class="text-red-500 text-sm">Error: Could not load files. Check console.</div>`;
            });
        };

        // --- Image Editing Logic ---
        const openImageEditor = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                ui.cropperImage.src = e.target.result;
                ui.imageEditorModal.classList.remove('hidden');
                if (cropper) cropper.destroy();
                cropper = new Cropper(ui.cropperImage, {
                    viewMode: 1, // Restrict crop box to be within the canvas
                    background: false,
                    autoCropArea: 0.8,
                    responsive: true,
                });
            };
            reader.readAsDataURL(file);
        };

        const closeImageEditor = () => {
            if (cropper) cropper.destroy();
            cropper = null;
            ui.cropperImage.src = ""; // Clear image source
            ui.imageEditorModal.classList.add('hidden');
        };

        const handleImageUpload = () => {
            if (!cropper || !userId) return;
            setButtonLoadingState(ui.confirmCropBtn, true);

            // Get cropped canvas, but limit its size for performance
            const croppedCanvas = cropper.getCroppedCanvas({
                maxWidth: 1920,
                maxHeight: 1080,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });

            croppedCanvas.toBlob(async (blob) => {
                if (!blob) {
                    showNotification("Failed to create image file.", true);
                    setButtonLoadingState(ui.confirmCropBtn, false);
                    return;
                }

                const imageName = `${userId}/${Date.now()}.png`;
                const storageRef = ref(storage, imageName);
                try {
                    await uploadBytes(storageRef, blob);
                    const downloadURL = await getDownloadURL(storageRef);
                    const markdownImage = `![pasted image](${downloadURL})`;
                    // Insert at cursor or append
                    const { selectionStart, selectionEnd } = ui.editor;
                    ui.editor.value = ui.editor.value.substring(0, selectionStart) + `\n${markdownImage}\n` + ui.editor.value.substring(selectionEnd);

                    showNotification("Image uploaded successfully!");
                    closeImageEditor();
                } catch (error) {
                    console.error("Image upload failed:", error);
                    let message = "Image upload failed. Check console.";
                    if (error.code?.includes('storage/unauthorized')) {
                        message = "Upload failed: Check Firebase Storage rules.";
                    }
                    showNotification(message, true);
                } finally {
                    setButtonLoadingState(ui.confirmCropBtn, false);
                }
            }, 'image/png', 0.9); // Use PNG with 90% quality
        };

        // --- Event Listeners Setup ---
        const attachEventListeners = () => {
            ui.newFileBtn.addEventListener('click', async () => {
                if (!userId) return showNotification("Authenticating... please wait.", true);
                try {
                    const docRef = await addDoc(collection(db, getPrivatePath()), {
                        content: "# New Note\n\nStart writing here.",
                        createdAt: serverTimestamp(),
                        isPublished: false,
                        ownerId: userId
                    });
                    selectFile(docRef.id);
                    switchMode('edit');
                } catch (e) { console.error("Error creating new file:", e); showNotification("Could not create note. Check permissions.", true); }
            });

            ui.saveBtn.addEventListener('click', async () => { if (await saveCurrentFile()) { showNotification("Note saved!"); switchMode('view'); }});

            ui.publishBtn.addEventListener('click', async () => {
                if (!currentFile || !userId) return;
                const publicRef = doc(db, getPublicPath(currentFile.id));
                const privateRef = doc(db, getPrivatePath(currentFile.id));

                if (currentFile.isPublished) {
                    showConfirmation("Unpublish Note?", "This will make the public link inactive. Are you sure?", async () => {
                        try {
                            await deleteDoc(publicRef);
                            await updateDoc(privateRef, { isPublished: false });
                            showNotification("Note unpublished.");
                        } catch (error) { console.error("Unpublish Error:", error); showNotification("Could not unpublish note.", true); }
                    });
                } else {
                     try {
                        await setDoc(publicRef, { content: currentFile.content, ownerId: userId, publishedAt: serverTimestamp() });
                        await updateDoc(privateRef, { isPublished: true });
                        const shareUrl = `${window.location.origin}${window.location.pathname}?view=${currentFile.id}`;
                        ui.shareUrlInput.value = shareUrl;
                        ui.shareModal.classList.remove('hidden');
                    } catch (error) { console.error("Publish Error:", error); showNotification("Could not publish note.", true); }
                }
            });

            ui.deleteBtn.addEventListener('click', () => {
                if (!currentFile || !userId) return;
                showConfirmation("Delete Note?", "This action cannot be undone. Are you sure?", async () => {
                    try {
                        if (currentFile.isPublished) await deleteDoc(doc(db, getPublicPath(currentFile.id)));
                        await deleteDoc(doc(db, getPrivatePath(currentFile.id)));
                        showNotification("Note deleted.");
                        resetToPlaceholder();
                    } catch (error) { console.error("Delete Error:", error); showNotification("Could not delete note.", true); }
                });
            });

            ui.summarizeBtn.addEventListener('click', async () => {
                if (!currentFile || ui.editor.value.trim().length < 50) {
                    return showNotification("Note is too short to summarize.", true);
                }
                setButtonLoadingState(ui.summarizeBtn, true);
                const prompt = "Summarize the following note into a concise, well-structured bulleted list in Markdown format:\n\n" + ui.editor.value;
                const summary = await callGemini(prompt);
                if (summary) {
                    ui.editor.value += `\n\n---\n\n**✨ AI Summary**\n${summary}`;
                    ui.viewer.innerHTML = marked.parse(ui.editor.value);
                }
                setButtonLoadingState(ui.summarizeBtn, false);
            });

            ui.brainstormBtn.addEventListener('click', async () => {
                if (!currentFile) return;
                const title = ui.editor.value.split('\n')[0].replace(/#/g, '').trim() || 'this topic';
                setButtonLoadingState(ui.brainstormBtn, true);
                const prompt = `You are a helpful brainstorming assistant. For the topic "${title}", generate a list of related ideas, sub-topics, and questions to explore. Format your response in Markdown, using lists and sub-lists.`;
                const ideas = await callGemini(prompt);
                if (ideas) {
                    ui.editor.value += `\n\n---\n\n**✨ Brainstormed Ideas**\n${ideas}`;
                    ui.viewer.innerHTML = marked.parse(ui.editor.value);
                }
                setButtonLoadingState(ui.brainstormBtn, false);
            });

            ui.viewSwitcher.addEventListener('click', (e) => { if (e.target.matches('.mode-btn')) switchMode(e.target.dataset.mode); });
            ui.fileList.addEventListener('click', (e) => { const item = e.target.closest('div[data-id]'); if(item) selectFile(item.dataset.id); });
            ui.viewer.addEventListener('click', (e) => { if (e.target.matches('a.internal-link')) { e.preventDefault(); selectFile(e.target.dataset.fileId); }});

            ui.copyShareUrlBtn.addEventListener('click', () => { ui.shareUrlInput.select(); document.execCommand('copy'); showNotification('Link copied!'); });
            ui.closeShareModalBtn.addEventListener('click', () => ui.shareModal.classList.add('hidden'));
            ui.modalCancelBtn.addEventListener('click', hideConfirmation);
            ui.modalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideConfirmation(); });

            ui.editor.addEventListener('paste', (e) => {
                if (e.clipboardData.files.length > 0) {
                    const file = e.clipboardData.files[0];
                    if (file.type.startsWith("image/")) {
                        e.preventDefault();
                        openImageEditor(file);
                    }
                }
            });
            ui.cancelCropBtn.addEventListener('click', closeImageEditor);
            ui.confirmCropBtn.addEventListener('click', handleImageUpload);
        };

        // --- Initialization ---
        const initialize = async () => {
            populateUI();
            attachEventListeners();

            const params = new URLSearchParams(window.location.search);
            const publicNoteId = params.get('view');

            loaderTimeout = setTimeout(() => {
                 if(ui.fileListLoader) ui.fileListLoader.innerHTML = `<div class="text-red-500 text-sm p-4 text-left"><strong class="font-bold block mb-2">Error: Loading Timed Out</strong>Check console (F12) for errors and verify Firebase config/rules.</div>`;
            }, 10000);

            if (!firebaseConfig?.apiKey) {
                clearTimeout(loaderTimeout);
                document.body.innerHTML = `<div class="p-4 bg-red-100 text-red-800"><strong>Config Missing:</strong> Please paste your Firebase config object into the script.</div>`;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); auth = getAuth(app); storage = getStorage(app);

                if (publicNoteId) {
                    // Public view mode
                    ui.appContainer.innerHTML = `<main class="w-full h-full"><div id="public-viewer" class="p-4 md:p-8 overflow-y-auto h-full markdown-body">Loading public note...</div></main>`;
                    const publicViewer = document.getElementById('public-viewer');
                    try {
                        const publicDoc = await getDoc(doc(db, getPublicPath(publicNoteId)));
                        if (publicDoc.exists()) {
                            publicViewer.innerHTML = marked.parse(publicDoc.data().content);
                        } else {
                            publicViewer.innerHTML = `<h2>Not Found</h2><p>This public note does not exist or was removed.</p>`;
                        }
                    } catch (e) {
                        publicViewer.innerHTML = `<h2>Error</h2><p>Could not load the public note.</p>`;
                    }
                } else {
                    // Normal app mode
                     onAuthStateChanged(auth, user => {
                        if (user) {
                            userId = user.uid;
                            if(ui.userIdDisplay) ui.userIdDisplay.textContent = userId;
                            setupFileListener();
                        } else {
                            signInAnonymously(auth).catch(err => {
                                clearTimeout(loaderTimeout);
                                if (ui.fileListLoader) ui.fileListLoader.textContent = "Authentication failed.";
                            });
                        }
                    });
                }
            } catch (error) {
                clearTimeout(loaderTimeout);
                if (ui.fileListLoader) ui.fileListLoader.textContent = "App failed to start.";
                else { document.body.innerHTML = `<div class="p-4 bg-red-100 text-red-800"><strong>App failed to start.</strong> Check console for details.</div>` }
            }
        };

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
